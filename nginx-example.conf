# Example Nginx reverse proxy for MAIL_API
# - Terminates TLS at Nginx
# - Forwards real client IP via X-Forwarded-For
# - You MUST set MAIL_API setting trusted_proxy_cidrs to include the Nginx IP/CIDR
#   Example: 127.0.0.1/32 (if proxying locally) or 192.168.250.10/32 (if Nginx is separate)

# Single-host setup on port 2500 with TLS
# - /         -> receiver (2555)
# - /admin/   -> control panel (2580)
server {
    listen 2500 ssl;
    server_name mail-api.example.com;

    ssl_certificate     /etc/letsencrypt/live/mail-api.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mail-api.example.com/privkey.pem;

    # Example IP restriction at Nginx layer for admin (optional but recommended)
    # location /admin/ {
    #     allow 192.168.250.0/24;
    #     deny all;
    # }

    location /admin/ {
        proxy_pass http://127.0.0.1:2580/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /admin;
    }

    location / {
        proxy_pass http://127.0.0.1:2555;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

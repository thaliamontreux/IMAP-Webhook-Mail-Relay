{% extends "base.html" %}

{% block page_title %}MAIL_API - 2FA{% endblock %}
{% block header_title %}2FA (TOTP){% endblock %}

{% block content %}
  <div class="row g-3">
    <div class="col-12 col-xl-7">
      <div class="card-glass p-4">
        <h2 class="h5 mb-3">Authenticator app (TOTP)</h2>

        {% if message %}
          <div class="alert alert-info mb-3" role="alert">
            {{ message }}
          </div>
        {% endif %}

        {% if error %}
          <div class="alert alert-danger mb-3" role="alert">
            {{ error }}
          </div>
        {% endif %}

        {% if totp_enabled %}
          <div style="color: var(--muted);" class="mb-3">
            2FA is currently <b>enabled</b> for <b>{{ user }}</b>.
          </div>

          <div class="mb-3" style="color: var(--muted);">
            Unused recovery codes: <b>{{ recovery_unused | default(0) }}</b>
          </div>

          <div class="mb-3">
            <form method="post" action="{{ prefix }}/2fa/recovery/generate">
              <div class="d-grid">
                <button type="submit" class="btn btn-outline-light">
                  <i class="fa-solid fa-key me-2"></i>
                  Generate recovery codes
                </button>
              </div>
            </form>
            <div class="form-text" style="color: var(--muted);">
              Recovery codes are one-time use. Generating new ones replaces any existing set.
            </div>
          </div>

          {% if new_recovery_codes %}
            <div class="mb-3">
              <label class="form-label">New recovery codes</label>
              <textarea class="form-control" rows="6" readonly>{% for c in new_recovery_codes %}{{ c }}
{% endfor %}</textarea>
              <div class="form-text" style="color: var(--muted);">
                Save these now. They won't be shown again.
              </div>
            </div>
          {% endif %}

          <form method="post" action="{{ prefix }}/2fa/disable">
            <div class="mb-3">
              <label class="form-label">Current 6-digit code</label>
              <input class="form-control" name="code" inputmode="numeric" autocomplete="one-time-code" />
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-outline-light">
                <i class="fa-solid fa-shield-halved me-2"></i>
                Disable 2FA
              </button>
            </div>
          </form>
        {% else %}
          <div style="color: var(--muted);" class="mb-3">
            2FA is currently <b>disabled</b> for <b>{{ user }}</b>.
          </div>

          {% if totp_secret %}
            <div class="mb-3">
              <label class="form-label">Secret (Base32)</label>
              <input class="form-control" value="{{ totp_secret }}" readonly />
            </div>

            {% if qr_available %}
              <div class="mb-3">
                <label class="form-label">QR Code</label>
                <div class="p-3" style="background: #fff; border-radius: 12px; display: inline-block;">
                  <img
                    src="{{ prefix }}/2fa/qr"
                    alt="TOTP QR"
                    style="width: 220px; height: 220px;"
                  />
                </div>
                <div class="form-text" style="color: var(--muted);">
                  Scan with Google Authenticator, 1Password, Authy, etc.
                </div>
              </div>
            {% endif %}

            <div class="mb-3">
              <label class="form-label">otpauth:// URI</label>
              <textarea class="form-control" rows="3" readonly>{{ otpauth_uri }}</textarea>
              <div class="form-text" style="color: var(--muted);">
                Most authenticator apps can scan a QR code, but you can also add this manually.
              </div>
            </div>

            <form method="post" action="{{ prefix }}/2fa/enable">
              <div class="mb-3">
                <label class="form-label">Enter a 6-digit code to enable</label>
                <input class="form-control" name="code" inputmode="numeric" autocomplete="one-time-code" />
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                  <i class="fa-solid fa-shield me-2"></i>
                  Enable 2FA
                </button>
              </div>
            </form>

            <form method="post" action="{{ prefix }}/2fa/generate" class="mt-3">
              <div class="d-grid">
                <button type="submit" class="btn btn-outline-light">
                  <i class="fa-solid fa-rotate me-2"></i>
                  Regenerate secret
                </button>
              </div>
            </form>
          {% else %}
            <form method="post" action="{{ prefix }}/2fa/generate">
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                  <i class="fa-solid fa-qrcode me-2"></i>
                  Generate secret
                </button>
              </div>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <div class="col-12 col-xl-5">
      <div class="card-glass p-4">
        <h2 class="h6 mb-3" style="color: var(--muted);">Notes</h2>
        <div style="color: var(--muted);">
          If you enable 2FA, logging in will require your password and a valid TOTP code.
        </div>
      </div>
    </div>
  </div>
{% endblock %}
